{% extends "base.html" %}

{% block title %}Instructor Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2 class="fw-bold">
                <i class="fas fa-clipboard-check me-2" style="color: var(--primary);"></i>
                Instructor Dashboard
            </h2>
            <p class="text-secondary">Review and approve credential claims</p>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Total Claims</div>
                <div class="stat-value">{{ stats.total_claims }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="border-color: var(--warning);">
                <div class="stat-label">Pending Approval</div>
                <div class="stat-value" style="color: var(--warning);">{{ stats.pending }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Approved This Week</div>
                <div class="stat-value">{{ stats.approved_week }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Total Minted</div>
                <div class="stat-value" style="color: var(--success);">{{ stats.total_minted }}</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold mb-0">
                    <i class="fas fa-list me-2"></i>Pending Claims
                </h5>
                <div class="d-flex gap-2">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search claims...">
                    </div>
                </div>
            </div>

            {% if pending_claims %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Type</th>
                            <th>Course</th>
                            <th>Submitted</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="claimsTable">
                        {% for claim in pending_claims %}
                        <tr data-claim-id="{{ claim.id }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user-circle fa-2x me-2 text-muted"></i>
                                    <div>
                                        <div class="fw-semibold">{{ claim.student_name }}</div>
                                        <small class="text-muted">{{ claim.student_email }}...</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge badge-{{ claim.credential_type.replace('-', '') }}">
                                    {{ claim.credential_type }}
                                </span>
                            </td>
                            <td>
                                <div class="fw-semibold">{{ claim.course_code }}</div>
                                <small class="text-muted">{{ claim.description[:50] if claim.description else 'N/A' }}</small>
                            </td>
                            <td>
                                <small>{{ claim.created_at.strftime('%Y-%m-%d') if claim.created_at else 'N/A' }}</small>
                            </td>
                            <td>
                                <span class="badge badge-{{ claim.status }}">{{ claim.status }}</span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-success" onclick="approveClaim({{ claim.id }})">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="rejectClaim({{ claim.id }})">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="btn btn-primary" onclick="viewClaim({{ claim.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                <h5 class="fw-bold">All Caught Up!</h5>
                <p class="text-muted">No pending claims to review</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row g-4 mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-check-double me-2" style="color: var(--primary);"></i>
                        Recently Approved
                    </h6>
                    {% if approved_claims %}
                        {% for claim in approved_claims[:5] %}
                        <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                            <div>
                                <div class="fw-semibold small">{{ claim.course_code }} - {{ claim.student_name }}</div>
                                <small class="text-muted">{{ claim.student_email }}...</small>
                            </div>
                            <span class="badge badge-approved">Approved</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted small">No approved claims yet</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-certificate me-2" style="color: var(--success);"></i>
                        Minted Credentials
                    </h6>
                    {% if minted_claims %}
                        {% for claim in minted_claims %}
                        <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                            <div>
                                <div class="fw-semibold small">{{ claim.course_code }} - {{ claim.student_name }}</div>
                                <small class="text-muted">Token #{{ claim.token_id }}</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                {% if claim.status == 'revoked' %}
                                    <span class="badge bg-danger">Revoked</span>
                                {% else %}
                                    <span class="badge badge-minted">Minted</span>
                                    <!-- Revoke Button -->
                                    <button class="btn btn-sm btn-outline-danger"
                                            onclick="revokeClaim({{ claim.id }})"
                                            title="Revoke Credential">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted small">No minted credentials yet</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="claimModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Claim Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="claimDetails">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function viewClaim(claimId) {
    const modal = new bootstrap.Modal(document.getElementById('claimModal'));
    modal.show();

    try {
        const response = await fetch(`/instructor/claim/${claimId}`);
        const claim = await response.json();

        document.getElementById('claimDetails').innerHTML = `
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="fw-semibold">Student</label>
                    <p>${claim.student_name}<br><small class="text-muted">${claim.student_address}</small></p>
                </div>
                <div class="col-md-6">
                    <label class="fw-semibold">Credential Type</label>
                    <p><span class="badge badge-${claim.credential_type.replace('-', '')}">${claim.credential_type}</span></p>
                </div>
                <div class="col-md-6">
                    <label class="fw-semibold">Course Code</label>
                    <p>${claim.course_code || 'N/A'}</p>
                </div>
                <div class="col-md-6">
                    <label class="fw-semibold">Course Name</label>
                    <p>${claim.course_name || 'N/A'}</p>
                </div>
                <div class="col-12">
                    <label class="fw-semibold">Description</label>
                    <p>${claim.description || 'No description provided'}</p>
                </div>
                ${claim.evidence_file ? `
                <div class="col-12">
                    <label class="fw-semibold">Evidence</label>
                    <p><i class="fas fa-file me-2"></i>${claim.evidence_file}</p>
                </div>` : ''}
            </div>
        `;
    } catch (error) {
        document.getElementById('claimDetails').innerHTML = '<p class="text-danger">Error loading claim details</p>';
    }
}

async function approveClaim(claimId) {
    if (!confirm('Approve this credential claim?')) return;

    try {
        const response = await fetch(`/instructor/approve/${claimId}`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error || 'Failed to approve claim', 'error');
        }
    } catch (error) {
        showToast('Error approving claim', 'error');
    }
}

async function rejectClaim(claimId) {
    const reason = prompt('Reason for rejection:');
    if (!reason) return;

    try {
        const response = await fetch(`/instructor/reject/${claimId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
        });
        const data = await response.json();

        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error || 'Failed to reject claim', 'error');
        }
    } catch (error) {
        showToast('Error rejecting claim', 'error');
    }
}

async function revokeClaim(claimId) {
    if (!confirm('WARNING: This will permanently REVOKE this credential on the blockchain. This cannot be undone. Are you sure?')) return;

    // Show loading state
    showToast('Revoking credential on blockchain... this may take a moment.', 'info');

    try {
        const response = await fetch(`/instructor/revoke/${claimId}`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showToast('Credential successfully revoked!', 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showToast(data.error || 'Failed to revoke claim', 'error');
        }
    } catch (error) {
        showToast('Error revoking claim', 'error');
    }
}

document.getElementById('searchInput')?.addEventListener('input', (e) => {
    const search = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#claimsTable tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    });
});
</script>
{% endblock %}